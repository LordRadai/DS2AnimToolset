@echo off

setlocal

:: Determine if double clicked in explorer. If so we want to pause on exit.
::
@echo %cmdcmdline% | findstr /l "\"\"" > NUL
if %ERRORLEVEL% EQU 0 (
  set PAUSE_ON_EXIT=1
)

:: Set up Visual Studio command line tools
::
call "%VS90COMNTOOLS%\vsvars32.bat"

:: Build the MDF code generator
::
devenv.com ..\..\tools\MDFCodeGen\MDFCodeGen_WIN32.vs2008.sln /build "Release Tool" /project MDFCodeGen

set MDF_BUILD_EXITCODE=%ERRORLEVEL%

if "%MDF_BUILD_EXITCODE%" NEQ "0" (
  exit /B %MDF_BUILD_EXITCODE%
)

:: Run MDF compiler
:: Output directory must be supplied by the caller of this batch file
..\..\..\bin\win32\vc9\MDFCodeGen.exe -p . -i Definition -o AutoGenerated %*

set MDF_RUN_EXITCODE=%ERRORLEVEL%

if "%MDF_RUN_EXITCODE%" NEQ "0" (
  echo MDF COMPILATION FAILED WITH EXIT CODE %MDF_RUN_EXITCODE%
  exit /B %MDF_RUN_EXITCODE%
)

if "%PAUSE_ON_EXIT%" == "1" pause
